{% if cart.item_count > 0 %}
    {% assign empty_cart_class = '' %}
{% else %}
    {% assign empty_cart_class = 'is-empty' %}
{% endif %}

<div id="CartDrawer" 
     class="fixed inset-0 z-50 {{ empty_cart_class }}"
     style="display: none;" 
     aria-modal="true" 
     role="dialog" 
     aria-label="Shopping Cart">

    <!-- Overlay -->
    <div id="CartDrawerOverlay"
         onclick="closeCartDrawer()"
         class="absolute inset-0 bg-black bg-opacity-50 transition-opacity duration-300"
         style="display: none; opacity: 0;">
    </div>

    <!-- Cart Drawer Content -->
    <div id="CartDrawerContent"
         class="absolute right-0 top-0 bottom-0 w-full sm:w-96 overflow-y-auto bg-[#F5F5DC] shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out pointer-events-auto">
        
        <div class="h-full flex flex-col justify-between">
            
            <div class="p-6">
                <div class="flex items-center justify-between border-b pb-4 mb-4">
                    <h2 class="text-2xl font-bold text-black">Your Bag (<span id="cart-drawer-count">{{ cart.item_count }}</span>)</h2>
                    <button type="button" 
                            onclick="closeCartDrawer()"
                            class="p-2 text-black hover:text-[#0077B6] text-2xl">
                        âœ•
                    </button>
                </div>

                {% if cart.item_count > 0 %}
                    <form action="{{ routes.cart_url }}" method="post" id="CartDrawerForm">
                        <div class="space-y-4" id="cart-drawer-items">
                            {% for item in cart.items %}
                                <div class="flex items-start cart-item" data-key="{{ item.key }}">
                                    <a href="{{ item.url }}" class="w-20 h-20 flex-shrink-0 mr-3">
                                        <img src="{{ item | img_url: 'small' }}" alt="{{ item.title | escape }}" class="w-full h-full object-cover rounded-md border">
                                    </a>
                                    
                                    <div class="flex-grow">
                                        <a href="{{ item.url }}" class="font-medium text-black hover:text-[#0077B6]">{{ item.product.title | truncatewords: 5 }}</a>
                                        <p class="text-sm text-gray-600 mb-1">{{ item.variant.title }}</p>
                                        
                                        <div class="flex items-center justify-between text-sm">
                                            <p class="font-bold text-black">{{ item.line_price | money }}</p>
                                            
                                            <input type="number" 
                                                   name="updates[]" 
                                                   id="updates_{{ item.key }}" 
                                                   value="{{ item.quantity }}" 
                                                   min="1" 
                                                   class="w-12 p-1 border text-center text-black rounded-md bg-white"
                                                   aria-label="Quantity">
                                            
                                            <button type="button" 
                                                    onclick="removeCartItem('{{ item.key }}')"
                                                    class="text-xs text-black hover:text-[#FA8072] underline">
                                                Remove
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </form>
                {% else %}
                    <div class="py-10 text-center">
                        <p class="text-lg text-black">Your bag is lonely! Add some products.</p>
                        <a href="{{ routes.all_products_collection_url }}" 
                           onclick="closeCartDrawer()"
                           class="mt-4 inline-block text-base font-medium text-black bg-[#FA8072] px-4 py-2 rounded transition duration-300 hover:bg-[#0077B6] hover:text-white">
                            Shop All
                        </a>
                    </div>
                {% endif %}
            </div>

            {% if cart.item_count > 0 %}
                <div class="p-6 border-t bg-white">
                    <div class="flex justify-between text-xl font-bold mb-3">
                        <span class="text-black">Subtotal:</span>
                        <span class="text-black" id="cart-drawer-total">{{ cart.total_price | money }}</span>
                    </div>

                    <p class="text-sm text-gray-600 mb-4">Shipping and taxes calculated at checkout.</p>
                    
                    <button type="submit" name="checkout" form="CartDrawerForm"
                            class="w-full p-3 font-semibold text-white bg-black rounded transition duration-300 
                                   hover:bg-[#FA8072] hover:text-black shadow-lg">
                        Checkout
                    </button>
                    
                    <a href="{{ routes.cart_url }}" 
                       onclick="closeCartDrawer()"
                       class="mt-3 w-full p-3 block text-center border border-black text-black rounded transition duration-300 hover:bg-gray-100 bg-white">
                       View Full Cart
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Cart Drawer Functions
    function toggleCartDrawer() {
        console.log('Toggle cart drawer called');
        const drawer = document.getElementById('CartDrawer');
        const overlay = document.getElementById('CartDrawerOverlay');
        const content = document.getElementById('CartDrawerContent');
        
        if (drawer.style.display === 'none' || drawer.style.display === '') {
            openCartDrawer();
        } else {
            closeCartDrawer();
        }
    }

    function openCartDrawer() {
        console.log('Opening cart drawer...');
        const drawer = document.getElementById('CartDrawer');
        const overlay = document.getElementById('CartDrawerOverlay');
        const content = document.getElementById('CartDrawerContent');
        
        // Show drawer and overlay
        drawer.style.display = 'block';
        overlay.style.display = 'block';
        
        // Force reflow
        drawer.offsetHeight;
        overlay.offsetHeight;
        
        // Animate overlay opacity
        setTimeout(() => {
            overlay.style.opacity = '1';
        }, 10);
        
        // Animate content slide-in
        setTimeout(() => {
            content.style.transform = 'translateX(0)';
        }, 50);
        
        // Prevent body scrolling
        document.body.style.overflow = 'hidden';
        
        console.log('Cart drawer opened');
    }

    function closeCartDrawer() {
        console.log('Closing cart drawer...');
        const drawer = document.getElementById('CartDrawer');
        const overlay = document.getElementById('CartDrawerOverlay');
        const content = document.getElementById('CartDrawerContent');
        
        // Slide out content
        content.style.transform = 'translateX(100%)';
        
        // Fade out overlay
        overlay.style.opacity = '0';
        
        // Hide everything after animation
        setTimeout(() => {
            drawer.style.display = 'none';
            overlay.style.display = 'none';
            overlay.style.opacity = '1'; // Reset for next open
            document.body.style.overflow = '';
        }, 300);
    }

    function removeCartItem(key) {
        if (!confirm('Remove this item from cart?')) return;
        
        fetch('/cart/change.js', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id: key,
                quantity: 0
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Item removed:', data);
            updateCartDrawer(data);
            updateCartCount(data.item_count);
            
            // If cart is now empty, reload after a delay
            if (data.item_count === 0) {
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        })
        .catch(error => console.error('Error removing item:', error));
    }

    function updateCartDrawer(cartData) {
        console.log('Updating cart drawer:', cartData);
        
        // Update cart count in drawer
        const countElement = document.getElementById('cart-drawer-count');
        if (countElement) {
            countElement.textContent = cartData.item_count;
        }
        
        // Update total
        const totalElement = document.getElementById('cart-drawer-total');
        if (totalElement) {
            totalElement.textContent = Shopify.formatMoney(cartData.total_price, '{{ shop.money_format }}');
        }
        
        // Dispatch event for other components
        const event = new CustomEvent('cart:updated', { detail: cartData });
        document.dispatchEvent(event);
    }

    // Update cart count in header
    function updateCartCount(count) {
        console.log('Updating cart count to:', count);
        const cartCountElements = document.querySelectorAll('.cart-count');
        cartCountElements.forEach(element => {
            element.textContent = count;
        });
    }

    // Close drawer with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeCartDrawer();
        }
    });

    // Close drawer when clicking outside content (on overlay)
    document.getElementById('CartDrawerOverlay')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeCartDrawer();
        }
    });

    // Listen for cart updates
    document.addEventListener('cart:updated', function(e) {
        console.log('Cart updated event received:', e.detail);
    });

    // Make functions globally available
    window.toggleCartDrawer = toggleCartDrawer;
    window.openCartDrawer = openCartDrawer;
    window.closeCartDrawer = closeCartDrawer;
    window.removeCartItem = removeCartItem;
    window.updateCartCount = updateCartCount;
</script>