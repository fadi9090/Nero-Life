{% comment %} sections/cart-drawer.liquid {% endcomment %}
<div id="cart-drawer" 
     class="fixed inset-y-0 right-0 w-full md:w-1/2 lg:w-1/3 xl:w-1/4 bg-white shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 overflow-y-auto"
     aria-hidden="true">
  
  <div class="h-full flex flex-col">
    <!-- Cart Header -->
    <div class="flex justify-between items-center p-4 border-b">
      <h2 class="text-xl font-bold">Your Cart ({{ cart.item_count }})</h2>
      <button onclick="toggleCartDrawer()" class="p-2 hover:text-gray-600">
        {% render 'icon-close' %}
      </button>
    </div>

    <!-- Cart Content -->
    <div class="flex-1 p-4 overflow-y-auto">
      {% if cart.item_count > 0 %}
        <form action="{{ routes.cart_url }}" method="POST" class="cart-form">
          {% for item in cart.items %}
            <div class="flex items-center py-4 border-b">
              <!-- Product Image -->
              <div class="flex-shrink-0 w-20 h-20">
                <a href="{{ item.url }}">
                  {% if item.image %}
                    <img src="{{ item.image | img_url: '120x120' }}" 
                         alt="{{ item.title | escape }}" 
                         class="w-full h-full object-cover">
                  {% else %}
                    {{ 'product-1' | placeholder_svg_tag: 'w-full h-full bg-gray-100' }}
                  {% endif %}
                </a>
              </div>

              <!-- Product Details -->
              <div class="ml-4 flex-1">
                <a href="{{ item.url }}" class="font-medium hover:text-blue-600">
                  {{ item.product.title | truncatewords: 4 }}
                </a>
                {% if item.variant.title != 'Default Title' %}
                  <p class="text-sm text-gray-500">{{ item.variant.title }}</p>
                {% endif %}
                <p class="text-sm font-medium">{{ item.price | money }}</p>

                <!-- Quantity Controls -->
                <div class="flex items-center mt-2">
                  <button type="button" 
                          onclick="updateQuantity({{ forloop.index }}, {{ item.quantity | minus: 1 }})"
                          class="w-8 h-8 flex items-center justify-center border rounded-l">
                    -
                  </button>
                  <input type="number" 
                         name="updates[]" 
                         value="{{ item.quantity }}" 
                         min="0"
                         data-line="{{ forloop.index }}"
                         class="w-12 h-8 text-center border-t border-b">
                  <button type="button" 
                          onclick="updateQuantity({{ forloop.index }}, {{ item.quantity | plus: 1 }})"
                          class="w-8 h-8 flex items-center justify-center border rounded-r">
                    +
                  </button>
                </div>
              </div>

              <!-- Remove and Price -->
              <div class="ml-4 text-right">
                <button type="button"
                        onclick="removeItem({{ forloop.index }})"
                        class="text-sm text-red-500 hover:text-red-700 mb-2">
                  Remove
                </button>
                <p class="font-medium">{{ item.line_price | money }}</p>
              </div>
            </div>
          {% endfor %}
        </form>
      {% else %}
        <!-- Empty Cart -->
        <div class="text-center py-10">
          <p class="text-gray-500 mb-4">Your cart is empty</p>
          <button onclick="toggleCartDrawer()" 
                  class="bg-gray-900 text-white px-6 py-2 rounded hover:bg-gray-800">
            Continue Shopping
          </button>
        </div>
      {% endif %}
    </div>

    <!-- Cart Footer -->
    {% if cart.item_count > 0 %}
      <div class="border-t p-4">
        <!-- Subtotal -->
        <div class="flex justify-between mb-4">
          <span class="font-medium">Subtotal</span>
          <span class="font-bold">{{ cart.total_price | money }}</span>
        </div>

        <!-- Tax Note -->
        <p class="text-sm text-gray-500 mb-4">
          Taxes and shipping calculated at checkout
        </p>

        <!-- Checkout Button -->
        <form action="{{ routes.cart_url }}" method="POST">
          <button type="submit" 
                  name="checkout"
                  class="w-full bg-black text-white py-3 rounded font-medium hover:bg-gray-800 mb-2">
            Checkout
          </button>
        </form>

        <!-- View Cart Button -->
        <a href="{{ routes.cart_url }}"
           class="block text-center text-gray-600 hover:text-gray-900 underline">
          View full cart
        </a>
      </div>
    {% endif %}
  </div>
</div>

<!-- Overlay -->
<div id="cart-overlay" 
     onclick="toggleCartDrawer()"
     class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden">
</div>

<style>
  #cart-drawer {
    top: 0;
    height: 100vh;
  }
  
  #cart-drawer.open {
    transform: translateX(0);
  }
  
  #cart-overlay.show {
    display: block;
  }
  
  /* Prevent body scroll when cart is open */
  body.cart-open {
    overflow: hidden;
  }
</style>

<script>
  // Cart drawer state
  let cartDrawerOpen = false;

  // Toggle cart drawer
  function toggleCartDrawer() {
    const drawer = document.getElementById('cart-drawer');
    const overlay = document.getElementById('cart-overlay');
    const body = document.body;
    
    cartDrawerOpen = !cartDrawerOpen;
    
    if (cartDrawerOpen) {
      drawer.classList.add('open');
      overlay.classList.add('show');
      body.classList.add('cart-open');
      document.addEventListener('keydown', handleEscapeKey);
    } else {
      drawer.classList.remove('open');
      overlay.classList.remove('show');
      body.classList.remove('cart-open');
      document.removeEventListener('keydown', handleEscapeKey);
    }
  }

  // Close on Escape key
  function handleEscapeKey(event) {
    if (event.key === 'Escape') {
      toggleCartDrawer();
    }
  }

  // Update item quantity
  async function updateQuantity(line, quantity) {
    if (quantity < 0) return;
    
    try {
      const response = await fetch(`${window.Shopify.routes.root}cart/change.js`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          line,
          quantity
        })
      });
      
      const cart = await response.json();
      updateCartUI(cart);
    } catch (error) {
      console.error('Error updating quantity:', error);
    }
  }

  // Remove item
  async function removeItem(line) {
    try {
      const response = await fetch(`${window.Shopify.routes.root}cart/change.js`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          line,
          quantity: 0
        })
      });
      
      const cart = await response.json();
      updateCartUI(cart);
    } catch (error) {
      console.error('Error removing item:', error);
    }
  }

  // Update cart UI
  function updateCartUI(cart) {
    // Update cart count in header
    document.querySelectorAll('.cart-count').forEach(el => {
      el.textContent = cart.item_count;
    });
    
    // If cart is empty, close drawer
    if (cart.item_count === 0) {
      setTimeout(() => {
        location.reload(); // Reload to show empty cart state
      }, 500);
    } else {
      // Reload the drawer content
      fetchCartDrawer();
    }
  }

  // Fetch and update cart drawer
  async function fetchCartDrawer() {
    try {
      const response = await fetch(`${window.Shopify.routes.root}?section_id=cart-drawer`);
      const html = await response.text();
      
      // Extract the cart drawer HTML
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newDrawer = doc.getElementById('cart-drawer');
      
      if (newDrawer) {
        const currentDrawer = document.getElementById('cart-drawer');
        currentDrawer.innerHTML = newDrawer.innerHTML;
      }
    } catch (error) {
      console.error('Error fetching cart drawer:', error);
    }
  }

  // Initialize cart functionality
  document.addEventListener('DOMContentLoaded', function() {
    // Update cart count on page load
    fetch(`${window.Shopify.routes.root}cart.js`)
      .then(response => response.json())
      .then(cart => {
        document.querySelectorAll('.cart-count').forEach(el => {
          el.textContent = cart.item_count;
        });
      });
  });
</script>