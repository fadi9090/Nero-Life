{% comment %} snippets/cart-drawer.liquid {% endcomment %}

<div id="cart-drawer" 
     class="fixed inset-y-0 right-0 w-full md:w-1/2 lg:w-1/3 xl:w-1/4 bg-white shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 overflow-y-auto"
     aria-hidden="true">
  
  <div class="h-full flex flex-col">
    <!-- Cart Header -->
    <div class="flex justify-between items-center p-4 border-b">
      <h2 class="text-xl font-bold">Your Cart (<span class="cart-count">{{ cart.item_count }}</span>)</h2>
      <button onclick="toggleCartDrawer()" class="p-2 hover:text-gray-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Cart Content -->
    <div class="flex-1 p-4 overflow-y-auto" id="cart-drawer-content">
      <!-- Content will be loaded via AJAX -->
    </div>

    <!-- Cart Footer -->
    <div class="border-t p-4 hidden" id="cart-drawer-footer">
      <!-- Subtotal -->
      <div class="flex justify-between mb-4">
        <span class="font-medium">Subtotal</span>
        <span class="font-bold" id="cart-subtotal">{{ cart.total_price | money }}</span>
      </div>

      <!-- Tax Note -->
      <p class="text-sm text-gray-500 mb-4">
        Taxes and shipping calculated at checkout
      </p>

      <!-- Checkout Button -->
      <form action="{{ routes.cart_url }}" method="POST">
        <button type="submit" 
                name="checkout"
                class="w-full bg-black text-white py-3 rounded font-medium hover:bg-gray-800 mb-2">
          Checkout
        </button>
      </form>

      <!-- View Cart Button -->
      <a href="{{ routes.cart_url }}"
         class="block text-center text-gray-600 hover:text-gray-900 underline">
        View full cart
      </a>
    </div>
  </div>
</div>

<!-- Overlay -->
<div id="cart-overlay" 
     onclick="toggleCartDrawer()"
     class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden">
</div>

<style>
  #cart-drawer {
    top: 0;
    height: 100vh;
  }
  
  #cart-drawer.open {
    transform: translateX(0);
  }
  
  #cart-overlay.show {
    display: block;
  }
  
  /* Prevent body scroll when cart is open */
  body.cart-open {
    overflow: hidden;
  }
</style>

<script>
  // Cart drawer state
  let cartDrawerOpen = false;

  // Toggle cart drawer
  function toggleCartDrawer() {
    const drawer = document.getElementById('cart-drawer');
    const overlay = document.getElementById('cart-overlay');
    const body = document.body;
    
    cartDrawerOpen = !cartDrawerOpen;
    
    if (cartDrawerOpen) {
      drawer.classList.add('open');
      overlay.classList.add('show');
      body.classList.add('cart-open');
      document.addEventListener('keydown', handleEscapeKey);
      loadCartDrawerContent();
    } else {
      drawer.classList.remove('open');
      overlay.classList.remove('show');
      body.classList.remove('cart-open');
      document.removeEventListener('keydown', handleEscapeKey);
    }
  }

  // Close on Escape key
  function handleEscapeKey(event) {
    if (event.key === 'Escape') {
      toggleCartDrawer();
    }
  }

  // Load cart content via AJAX
  async function loadCartDrawerContent() {
    try {
      const response = await fetch(`${window.Shopify.routes.root}cart.js`);
      const cart = await response.json();
      updateCartDrawer(cart);
    } catch (error) {
      console.error('Error loading cart:', error);
    }
  }

  // Update cart drawer with cart data
  function updateCartDrawer(cart) {
    const content = document.getElementById('cart-drawer-content');
    const footer = document.getElementById('cart-drawer-footer');
    const subtotal = document.getElementById('cart-subtotal');
    
    // Update cart count in header
    document.querySelectorAll('.cart-count').forEach(el => {
      el.textContent = cart.item_count;
    });
    
    if (cart.item_count === 0) {
      // Empty cart
      content.innerHTML = `
        <div class="text-center py-10">
          <p class="text-gray-500 mb-4">Your cart is empty</p>
          <button onclick="toggleCartDrawer()" 
                  class="bg-gray-900 text-white px-6 py-2 rounded hover:bg-gray-800">
            Continue Shopping
          </button>
        </div>
      `;
      footer.classList.add('hidden');
    } else {
      // Cart has items
      let itemsHTML = '';
      
      cart.items.forEach((item, index) => {
        const line = index + 1;
        itemsHTML += `
          <div class="flex items-center py-4 border-b">
            <div class="flex-shrink-0 w-20 h-20">
              <a href="${item.url}">
                <img src="${item.image}" 
                     alt="${item.title.replace(/"/g, '&quot;')}" 
                     class="w-full h-full object-cover">
              </a>
            </div>
            
            <div class="ml-4 flex-1">
              <a href="${item.url}" class="font-medium hover:text-blue-600">
                ${item.title}
              </a>
              ${item.variant_title !== 'Default Title' ? `<p class="text-sm text-gray-500">${item.variant_title}</p>` : ''}
              <p class="text-sm font-medium">${formatMoney(item.price)}</p>
              
              <div class="flex items-center mt-2">
                <button type="button" 
                        onclick="updateQuantity(${line}, ${item.quantity - 1})"
                        class="w-8 h-8 flex items-center justify-center border rounded-l ${item.quantity <= 1 ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${item.quantity <= 1 ? 'disabled' : ''}>
                  -
                </button>
                <span class="w-12 h-8 flex items-center justify-center border-t border-b">
                  ${item.quantity}
                </span>
                <button type="button" 
                        onclick="updateQuantity(${line}, ${item.quantity + 1})"
                        class="w-8 h-8 flex items-center justify-center border rounded-r">
                  +
                </button>
              </div>
            </div>
            
            <div class="ml-4 text-right">
              <button type="button"
                      onclick="removeItem(${line})"
                      class="text-sm text-red-500 hover:text-red-700 mb-2">
                Remove
              </button>
              <p class="font-medium">${formatMoney(item.line_price)}</p>
            </div>
          </div>
        `;
      });
      
      content.innerHTML = itemsHTML;
      subtotal.textContent = formatMoney(cart.total_price);
      footer.classList.remove('hidden');
    }
  }

  // Format money
  function formatMoney(cents) {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD'
    }).format(cents / 100);
  }

  // Update item quantity
  async function updateQuantity(line, quantity) {
    if (quantity < 0) return;
    
    try {
      const response = await fetch(`${window.Shopify.routes.root}cart/change.js`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          line,
          quantity
        })
      });
      
      const cart = await response.json();
      updateCartDrawer(cart);
    } catch (error) {
      console.error('Error updating quantity:', error);
    }
  }

  // Remove item
  async function removeItem(line) {
    try {
      const response = await fetch(`${window.Shopify.routes.root}cart/change.js`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          line,
          quantity: 0
        })
      });
      
      const cart = await response.json();
      updateCartDrawer(cart);
    } catch (error) {
      console.error('Error removing item:', error);
    }
  }

  // Initialize cart functionality
  document.addEventListener('DOMContentLoaded', function() {
    // Update cart count on page load
    fetch(`${window.Shopify.routes.root}cart.js`)
      .then(response => response.json())
      .then(cart => {
        document.querySelectorAll('.cart-count').forEach(el => {
          el.textContent = cart.item_count;
        });
      });
  });
</script>