<div id="CartDrawer" 
     class="fixed inset-0 z-50"
     style="display: none;" 
     aria-modal="true" 
     role="dialog" 
     aria-label="Shopping Cart">

    <!-- Overlay -->
    <div id="CartDrawerOverlay"
         onclick="closeCartDrawer()"
         class="absolute inset-0 bg-black bg-opacity-50 transition-opacity duration-300"
         style="display: none; opacity: 0;">
    </div>

    <!-- Cart Drawer Content -->
    <div id="CartDrawerContent"
         class="absolute right-0 top-0 bottom-0 w-full sm:w-96 overflow-y-auto bg-[#F5F5DC] shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out pointer-events-auto">
        
        <div class="h-full flex flex-col justify-between">
            
            <div class="p-6">
                <div class="flex items-center justify-between border-b pb-4 mb-4">
                    <h2 class="text-2xl font-bold text-black">Your Bag (<span id="cart-drawer-count">{{ cart.item_count }}</span>)</h2>
                    <button type="button" 
                            onclick="closeCartDrawer()"
                            class="p-2 text-black hover:text-[#0077B6] text-2xl">
                        âœ•
                    </button>
                </div>

                <div id="cart-drawer-items">
                  <!-- Will be populated by JavaScript -->
                </div>
                
                <div id="cart-drawer-empty" class="py-10 text-center" style="display: none;">
                    <p class="text-lg text-black">Your bag is lonely! Add some products.</p>
                    <a href="{{ routes.all_products_collection_url }}" 
                       onclick="closeCartDrawer()"
                       class="mt-4 inline-block text-base font-medium text-black bg-[#FA8072] px-4 py-2 rounded transition duration-300 hover:bg-[#0077B6] hover:text-white">
                        Shop All
                    </a>
                </div>
            </div>

            <div id="cart-drawer-footer" class="p-6 border-t bg-white" style="display: none;">
                <div class="flex justify-between text-xl font-bold mb-3">
                    <span class="text-black">Subtotal:</span>
                    <span class="text-black" id="cart-drawer-total">{{ cart.total_price | money }}</span>
                </div>

                <p class="text-sm text-gray-600 mb-4">Shipping and taxes calculated at checkout.</p>
                
                <form action="{{ routes.cart_url }}" method="post" id="CartDrawerForm">
                  <button type="submit" name="checkout"
                          class="w-full p-3 font-semibold text-white bg-black rounded transition duration-300 
                                 hover:bg-[#FA8072] hover:text-black shadow-lg">
                      Checkout
                  </button>
                </form>
                
                <a href="{{ routes.cart_url }}" 
                   onclick="closeCartDrawer()"
                   class="mt-3 w-full p-3 block text-center border border-black text-black rounded transition duration-300 hover:bg-gray-100 bg-white">
                   View Full Cart
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Cart Drawer Functions
function toggleCartDrawer() {
    const drawer = document.getElementById('CartDrawer');
    if (drawer.style.display === 'none' || drawer.style.display === '') {
        openCartDrawer();
    } else {
        closeCartDrawer();
    }
}

function openCartDrawer() {
    const drawer = document.getElementById('CartDrawer');
    const overlay = document.getElementById('CartDrawerOverlay');
    const content = document.getElementById('CartDrawerContent');
    
    // Load cart contents
    loadCartDrawer();
    
    // Show drawer and overlay
    drawer.style.display = 'block';
    overlay.style.display = 'block';
    
    // Animate
    setTimeout(() => {
        overlay.style.opacity = '1';
        content.style.transform = 'translateX(0)';
    }, 10);
    
    document.body.style.overflow = 'hidden';
}

function closeCartDrawer() {
    const drawer = document.getElementById('CartDrawer');
    const overlay = document.getElementById('CartDrawerOverlay');
    const content = document.getElementById('CartDrawerContent');
    
    content.style.transform = 'translateX(100%)';
    overlay.style.opacity = '0';
    
    setTimeout(() => {
        drawer.style.display = 'none';
        overlay.style.display = 'none';
        document.body.style.overflow = '';
    }, 300);
}

function loadCartDrawer() {
    fetch('/cart.js')
        .then(response => response.json())
        .then(cart => {
            updateCartDrawer(cart);
        });
}

function updateCartDrawer(cart) {
    // Update count
    const countElement = document.getElementById('cart-drawer-count');
    if (countElement) countElement.textContent = cart.item_count;
    
    // Update total
    const totalElement = document.getElementById('cart-drawer-total');
    if (totalElement) totalElement.textContent = Shopify.formatMoney(cart.total_price, '{{ shop.money_format }}');
    
    // Update header cart count
    updateCartCount(cart.item_count);
    
    const itemsContainer = document.getElementById('cart-drawer-items');
    const emptyContainer = document.getElementById('cart-drawer-empty');
    const footerContainer = document.getElementById('cart-drawer-footer');
    
    if (cart.item_count > 0) {
        emptyContainer.style.display = 'none';
        footerContainer.style.display = 'block';
        
        // Render items
        let itemsHTML = '';
        cart.items.forEach(item => {
            itemsHTML += `
                <div class="flex items-start cart-item mb-4" data-key="${item.key}">
                    <a href="${item.url}" class="w-20 h-20 flex-shrink-0 mr-3">
                        <img src="${item.image}" alt="${item.title}" class="w-full h-full object-cover rounded-md border">
                    </a>
                    
                    <div class="flex-grow">
                        <a href="${item.url}" class="font-medium text-black hover:text-[#0077B6]">${item.product_title}</a>
                        <p class="text-sm text-gray-600 mb-1">${item.variant_title}</p>
                        
                        <div class="flex items-center justify-between text-sm">
                            <p class="font-bold text-black">${Shopify.formatMoney(item.line_price, '{{ shop.money_format }}')}</p>
                            
                            <input type="number" 
                                   value="${item.quantity}" 
                                   min="1" 
                                   class="w-12 p-1 border text-center text-black rounded-md bg-white quantity-input"
                                   data-key="${item.key}"
                                   aria-label="Quantity">
                            
                            <button type="button" 
                                    onclick="removeCartItem('${item.key}')"
                                    class="text-xs text-black hover:text-[#FA8072] underline">
                                Remove
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        itemsContainer.innerHTML = itemsHTML;
        
        // Add event listeners for quantity inputs
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', function() {
                updateCartItem(this.dataset.key, this.value);
            });
        });
        
    } else {
        itemsContainer.innerHTML = '';
        emptyContainer.style.display = 'block';
        footerContainer.style.display = 'none';
    }
}

function updateCartItem(key, quantity) {
    fetch('/cart/change.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: key, quantity: parseInt(quantity) })
    })
    .then(response => response.json())
    .then(cart => {
        updateCartDrawer(cart);
    });
}

function removeCartItem(key) {
    if (!confirm('Remove this item from cart?')) return;
    
    fetch('/cart/change.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: key, quantity: 0 })
    })
    .then(response => response.json())
    .then(cart => {
        updateCartDrawer(cart);
    });
}

function updateCartCount(count) {
    document.querySelectorAll('.cart-count').forEach(element => {
        element.textContent = count;
    });
}

// Event Listeners
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeCartDrawer();
});

document.getElementById('CartDrawerOverlay')?.addEventListener('click', function(e) {
    if (e.target === this) closeCartDrawer();
});

// Make functions globally available
window.toggleCartDrawer = toggleCartDrawer;
window.openCartDrawer = openCartDrawer;
window.closeCartDrawer = closeCartDrawer;
window.removeCartItem = removeCartItem;
window.updateCartCount = updateCartCount;

// Initialize cart count on page load
document.addEventListener('DOMContentLoaded', function() {
    updateCartCount({{ cart.item_count }});
});
</script>